---
title: "HW04 - 데이터 정비하기"
author: "X-ray조 - 박소화, 전성훈, 임혜연"
date: '2021. 03. 28.'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
<br/><br/>

***

<br/><br/>

#### 1. 기본세팅
<br/>
 기본세팅은 다음과 같습니다.
```{r}
library(tidyverse)
library(gridExtra)
```
<br/><br/>

***

<br/><br/>

#### 2. 데이터 불러오기
<br/>
```{r}
enterprise <- read.csv("enterprise.csv")
population_density <- read.csv("population_density.csv")
enterprise_2019 <- read.csv("enterprise_2019.csv")
registered <- read.csv("registered.csv")
parkinglot <- read.csv("parkinglot.csv")
```
<br/>
 저희 조는 **서울 열린데이터광장(data.seoul.go.kr)**에서<br/>- 2018년 서울시 행정동별 사업체 수<br/>- 2018년 서울시 행정동별 인구밀도<br/>- 2019년 서울시 행정동별 사업체 수<br/>- 2018년 서울시 행정동별 등록 외국인 수<br/>- 2018년 서울시 행정동별 주차장 수<br/>데이터를 활용했습니다.
<br/><br/>

***

<br/><br/>

#### 3. 데이터 기본 가공
<br/>
 1. 행정동별 데이터만 추출
 
```{r}

enterprise <- enterprise[-c(1, 2, 3, 4, 22, 38, 55, 73, 89, 104, 121, 142, 156, 171, 191, 208, 223, 240, 259, 280, 296, 307, 326, 342, 364, 383, 406, 434),];

population_density <- population_density[-c(1, 2, 20, 36, 53, 71, 87, 102, 119, 140, 154, 169, 189, 206, 221, 238, 257, 278, 294, 305, 324, 340, 362, 381, 404, 432),];

```
<br/>
 행정동별 데이터 가공을 좀 더 용이하게 하기 위하여 원데이터에 존재했던 총합계와 구별 합계를 나타내는 행을 지정하여 제거해주었습니다.
<br/><br/><br/>
 2. 변수 이름 지정
```{r}
names(enterprise) <- c("기간",
                       "자치구",
                       "동",
                       "전체_사업체수",
                       "여성대표자_사업체수",
                       "종사자수_계",
                       "남성_종사자수",
                       "여성_종사자수",
                       "개인_사업체수",
                       "개인_종사자수",
                       "법인_사업체수",
                       "법인_종사자수",
                       "회사이외의법인_사업체수",
                       "회사이외의법인_종사자수",
                       "비법인단체_사업체수",
                       "비법인단체_종사자수")
as_tibble(enterprise) %>% 
        DT::datatable()

```
<br/>
 위 작업은 원데이터에서 세 개의 행으로 나누어져있던 변수의 이름을 각각 하나의 변수로 지정해주는 작업입니다.
<br/><br/><br/>
 3. 자료형 변환
 
```{r}
enterprise$기간 <- as.integer(enterprise$기간)
```

```{r}
enterprise$전체_사업체수 <- as.integer(enterprise$전체_사업체수)
```

```{r}
enterprise$여성대표자_사업체수 <- as.integer(enterprise$여성대표자_사업체수)
```

```{r}
enterprise$종사자수_계 <- as.integer(enterprise$종사자수_계)
```

```{r}
enterprise$남성_종사자수 <- as.integer(enterprise$남성_종사자수)
```

```{r}
enterprise$여성_종사자수 <- as.integer(enterprise$여성_종사자수)
```

```{r}
enterprise$개인_사업체수 <- as.integer(enterprise$개인_사업체수)
```

```{r}
enterprise$개인_종사자수 <- as.integer(enterprise$개인_종사자수)
```

```{r}
enterprise$법인_사업체수 <- as.integer(enterprise$법인_사업체수)
```

```{r}
enterprise$법인_종사자수 <- as.integer(enterprise$법인_종사자수)
```

```{r}
enterprise$회사이외의법인_사업체수 <- as.integer(enterprise$회사이외의법인_사업체수)
```

```{r}
enterprise$회사이외의법인_종사자수 <- as.integer(enterprise$회사이외의법인_종사자수)
```

```{r}
enterprise$비법인단체_사업체수 <- as.integer(enterprise$비법인단체_사업체수)
```

```{r}
enterprise$비법인단체_종사자수 <- as.integer(enterprise$비법인단체_종사자수)
```
<br/>
 위 작업은 원래의 csv파일에서 문자형데이터로 지정되어있던 변수들을 정수형데이터로 변경해주는 작업입니다.<br/>
 이로써 tidyr과 dplyr의 기능들을 사용할 수 있는 데이터로 변경되었습니다.
<br/><br/>

***

<br/><br/>

#### 4. 함수 적용과 시각화
<br/>
 **1. select, mutate, arrange**
```{r}
# 사업체 당 종사자 수가 많은 순서대로 정렬
select(enterprise, 기간, 자치구, 동, 전체_사업체수, 종사자수_계) %>% 
 mutate(사업체당_종사자수 = 종사자수_계 / 전체_사업체수) %>% 
 arrange(desc(사업체당_종사자수)) %>%
        DT::datatable()
```
<br/>
 먼저 select를 이용해 분석에 이용할 변수만을 선택하여 데이터 변수의 개수를 줄여주었습니다.<br/>그 후 mutate를 통해 '사업체당 종사자수'라는 새로운 변수를 추가했습니다.<br/>이후 사업체당 종사자수를 기준으로 내림차순 정렬을 해주었습니다.
<br/><br/><br/>
```{r}
#시각화
data_1 <- select(enterprise, 기간, 자치구, 동, 전체_사업체수, 종사자수_계) %>% 
 mutate("사업체당_종사자수" = 종사자수_계 / 전체_사업체수)
graph_1 <- count(data_1, cut_width(사업체당_종사자수, 3, boundary = 0))
names(graph_1) <- c("worker", "count")
ggplot(data = graph_1) + 
        ggtitle("사업체 당 종사자 수 분포") +
        geom_col(mapping = aes(x = worker, y = count)) +
        labs(x = " ", y = " ") +
        theme(plot.title = element_text(color = "darkblue", size = 16))
        
        
```
```{r}
qqnorm(data_1$전체_사업체수)
```

```{r}
qqnorm(data_1$종사자수_계)
```
<br/><br/><br/><br/>
 **2. group_by, summarize, arrange**
```{r}
# 사업체 수가 많은 순서대로 구를 정렬
group_by(enterprise, 자치구) %>% 
 summarize("전체_사업체수" = sum(전체_사업체수)) %>% 
 arrange(desc(전체_사업체수)) %>% 
        DT::datatable()
```
<br/>
 group_by를 통해 각 행정동을 자치구 단위로 묶어주었습니다. 즉, 구 별로 그룹화를 하기 위한 작업입니다.<br/>그 후 summarize와 sum을 사용하여 각 자치구에 존재하는 사업체 수를 구했습니다.<br/>이후에는 사업체수를 기준으로 구별 내림차순 정렬을 해주었습니다.
<br/><br/><br/>
```{r}
#시각화
ggplot(data=group_by(enterprise, 자치구))+
 geom_bar(mapping=aes(x=자치구))+
 theme(axis.text.x=element_text(angle=90, hjust=1))+
ggtitle("자치구별 사업체수")+
theme(plot.title = element_text(color = "darkblue", size = 16))
```
<br/><br/><br/><br/>
 **3. count**
```{r}
#남성대표자 사업체보다 여성대표자 사업체가 더 많은 동의 개수
count(enterprise, 여성대표자_사업체수 / 전체_사업체수 > 0.5) %>% 
        DT::datatable(caption="남성대표자 사업체보다 여성대표자 사업체가 더 많은 동의 개수")
```
<br/>
count를 이용하여 여성대표자를 가진 사업체가 남성대표자를 가진 사업체보다 더 많은 동의 개수를 세어보았습니다.<br/>그 결과 서울 전체 424개의 행정동 중 7개의 동에서 여성이 대표자로 있는 사업체 수가 남성이 대표자로 있는 사업체 수보다 많음을 확인할 수 있었습니다.
<br/><br/><br/>
```{r}
#시각화
data_3 <- count(enterprise, 여성대표자_사업체수 / 전체_사업체수 > 0.5)
names(data_3) <- c("more_female", "n")
ggplot(data = data_3, aes(x = " ", y = n,
                          fill = more_female)) +
        geom_bar(stat = "identity", width = 1) +
        ggtitle("여성 대표자 사업체가 남성 대표자 사업체보다 많은 동의 비중") +
        coord_polar(theta = "y") +
        labs(x = " ", y = " ", fill = "여성 대표자 사업체가 남성 대표자 사업체보다 많다") +
        theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
        theme(plot.title = element_text(color = "darkblue", size = 16))
        
```
<br/><br/><br/><br/>
 **4. filter, select**
```{r}
#개인사업체보다 법인사업체가 더 많은 동만 필터링

select(enterprise, 기간, 자치구, 동, 개인_사업체수, 법인_사업체수) %>% 
 filter(법인_사업체수 > 개인_사업체수) %>% 
        DT::datatable()
```
<br/>
 우선 select를 사용하여 개인 사업체수와 법인 사업체수 변수만을 추출하였습니다.<br/>이후 filter를 통해 법인 사업체수가 개인 사업체 수보다 많은 동만을 나타내보았습니다. 그 결과 6개의 동만이 개인보다 법인 사업체 수가 많은 것으로 드러났습니다.
<br/><br/><br/>
```{r}
#시각화
data_4 <- filter(enterprise, 법인_사업체수 > 개인_사업체수) %>% 
 select(기간, 자치구, 동, 개인_사업체수, 법인_사업체수)

data_41 <- filter(data_4, 자치구 == "구로구")
graph_41 <- gather(data_41, 개인_사업체수, 법인_사업체수, key = "type", value = "n") 
a = ggplot(data = graph_41) +
geom_col(mapping = aes(x = type, y = n, fill = type), width = 0.6, 
         position = "dodge", colour = "black") +
         labs(x = "구로구 구로3동", y = " ") +
        theme(axis.text.x = element_text(size = 8), legend.position = "none") +
        scale_fill_brewer(palette="Pastel1")

data_42 <- filter(data_4, 자치구 == "금천구")
graph_42 <- gather(data_42, 개인_사업체수, 법인_사업체수, key = "type", value = "n")
b = ggplot(data = graph_42) +
        geom_col(mapping = aes(x = type, y = n, fill = type), width = 0.6,
                 position = "dodge", colour = "black") +
        labs(x = "금천구 가산동", y = " ") +
        theme(axis.text.x = element_text(size = 8), legend.position = "none") +
        scale_fill_brewer(palette="Pastel1")

data_43 <- filter(data_4, 자치구 == "영등포구")
graph_43 <- gather(data_43, 개인_사업체수, 법인_사업체수, key = "type", value = "n")
c = ggplot(data = graph_43) +
        geom_col(mapping = aes(x = type, y = n, fill = type), width = 0.6,
                 position = "dodge", colour = "black") +
        labs(x = "영등포구 여의동", y = " ") +
        theme(axis.text.x = element_text(size = 8), legend.position = "none") +
        scale_fill_brewer(palette="Pastel1")

data_44 <- filter(data_4, 자치구 == "서초구")
graph_44 <- gather(data_44, 개인_사업체수, 법인_사업체수, key = "type", value = "n")
d = ggplot(data = graph_44) +
        geom_col(mapping = aes(x = type, y = n, fill = type), width = 0.6,
                 position = "dodge", colour = "black") +
        labs(x = "서초구 서초2동", y = " ") +
        theme(axis.text.x = element_text(size = 8), legend.position = "none") +
         scale_fill_brewer(palette="Pastel1")

data_45 <- filter(data_4, 자치구 == "강남구")
graph_45 <- gather(data_45, 개인_사업체수, 법인_사업체수, key = "type", value = "n")
e = ggplot(data = graph_45) +
        geom_col(mapping = aes(x = type, y = n, fill = type), width = 0.6,
                 position = "dodge", colour = "black") +
        labs(x = "강남구 삼성1동", y = " ") +
        theme(axis.text.x = element_text(size = 8), legend.position = "none") +
        scale_fill_brewer(palette="Pastel1")

data_46 <- filter(data_4, 자치구 == "송파구")
graph_46 <- gather(data_46, 개인_사업체수, 법인_사업체수, key = "type", value = "n")
f = ggplot(data = graph_46) +
        geom_col(mapping = aes(x = type, y = n, fill = type), width = 0.6,
                 position = "dodge", colour = "black") +
        labs(x = "송파구 가락1동", y = " ") +
        theme(axis.text.x = element_text(size = 8), legend.position = "none") +
        scale_fill_brewer(palette="Pastel1")

grid.arrange(a, b, c, d, e, f, nrow = 2, ncol = 3)
```
<br/><br/><br/><br/>
 **5. select, left_join, mutate, arrange**
```{r}
#면적 대비 사업체 수가 많은 동부터 정렬
population_density <- select(population_density, 동, 인구, 인구밀도, 면적)

left_join(enterprise, population_density, by = "동") %>% 
 select(기간, 자치구, 동, 전체_사업체수, 면적) %>% 
 mutate("면적당_사업체수" = 전체_사업체수 / 면적) %>% 
 arrange(desc(면적당_사업체수)) %>% 
        DT::datatable()

```
<br/>
 먼저 내부조인을 하기 위해 공통변수를 선정해야 했습니다.<br/>'동'을 기준으로 조인을 수행할 예정이기 때문에, population_density와 enterprise 두 데이터 모두에 포함된 기간과 자치구가 중복되지 않게 하기 위하여 우선 population_density 데이터에서 기간과 자치구를 제외한 나머지 변수들을 선택해주었습니다.<br/>이후 동을 기준으로 두 데이터를 조인한 후 population_density 데이터에서는 면적 변수만을 사용하기 위해 select로 선택하는 작업을 했습니다.<br/>mutate를 사용하여 '면적당 사업체수'라는 새로운 변수를 추가하고, arrange로 내림차순 정렬을 한 결과 종로 1.2.3.4가동에 사업체들이 가장 밀집되어 있음을 확인할 수 있었습니다.
<br/><br/><br/>
```{r}
#시각화
data_5 <- left_join(enterprise, population_density, by = "동") %>% 
 select(기간, 자치구, 동, 전체_사업체수, 면적) %>% 
 mutate("면적당_사업체수" = 전체_사업체수 / 면적)

ggplot(data = data_5) +
        ggtitle("면적당 사업체 수 분포") +
        geom_point(mapping = aes(x = 전체_사업체수, y = 면적)) +
        theme(plot.title = element_text(color = "darkblue", size = 16))
```
<br/><br/><br/><br/>
 **6. select, separate**
```{r}
# 사업체 수와 종사자 수의 단위를 변경
select(enterprise, 기간, 자치구, 동, 전체_사업체수, 종사자수_계) %>% 
        separate(전체_사업체수, 
                into = c("전체_사업체수_백개", "전체_사업체수_나머지"),
                sep = -2, convert = TRUE) %>% 
        separate(종사자수_계, 
                into = c("종사자수_계_천명", "종사자수_계_나머지"),
                sep = -3, convert = TRUE) %>%
        select(기간, 자치구, 동, 전체_사업체수_백개, 종사자수_계_천명) %>% 
        DT::datatable()
```
<br/>
 먼저, select를 통해 enterprise 데이터에서 전체 사업체수와 종사자수 계의 변수만을 추출했습니다.<br/>이후, separate를 사용하여 전체 사업체수는 100개 단위로, 종사자 수는 1,000명 단위로 변환했습니다.<br/>각각 백의 자리와 천의 자리 미만의 수는 버림되었습니다.
<br/><br/><br/>
```{r}
#시각화
data_6 <- select(enterprise, 기간, 자치구, 동, 전체_사업체수, 종사자수_계) %>% 
        separate(전체_사업체수, 
                into = c("전체_사업체수_백개", "전체_사업체수_나머지"),
                sep = -2, convert = TRUE) %>% 
        separate(종사자수_계, 
                into = c("종사자수_계_천명", "종사자수_계_나머지"),
                sep = -3, convert = TRUE) %>%
        select(기간, 자치구, 동, 전체_사업체수_백개, 종사자수_계_천명)
boxplot(data_6$"전체_사업체수_백개", horizontal=T, main="전체 사업체수 분포", xlab="동별 사업체수(백의자리 미만 버림)")
```

```{r}
boxplot(data_6$"종사자수_계_천명", horizontal=T, main="전체 종사자수 분포", xlab="동별 종사자수(천의자리 미만 버림)")
```
<br/><br/><br/><br/>
 **7. unite**
```{r}
# 구와 동을 하나의 열로 합침
unite(enterprise, "구_동", 자치구, 동, sep = " ") %>% 
        DT::datatable()
```
<br/>
 unite를 사용하여 구와 동을 하나의 변수로 합쳐주었습니다.
<br/><br/><br/><br/>
 **8. nest, group_by**
```{r}
# 같은 구에 속한 동끼리 묶기
enterprise_nest <- group_by(enterprise, 자치구) %>% 
                   nest()
enterprise_nest %>% 
        as_tibble ()
```
<br/>
 우선, nest를 사용하여 자치구 별로 tibble을 생성하였습니다. 각 tibble의 행은 해당 자치구에 속하는 행정동이며 열은 전체 변수입니다.
<br/>

```{r}
enterprise_nest$data[[1]] %>% 
        DT::datatable()
```
<br/> 
 위 자료는 각 구별 그룹 중 종로구를 선택하여 예시로 보여준 것입니다.
<br/><br/><br/><br/>
 **9. pivot_longer**
```{r}
# 각 행정동에 위치한 유형별 사업체 개수
unite(enterprise, "구_동", 자치구, 동, sep = " ") %>% 
        select(구_동, 개인_사업체수, 법인_사업체수, 
                  회사이외의법인_사업체수, 비법인단체_사업체수) %>%
        pivot_longer(!구_동, names_to = "사업체_유형", values_to = "사업체_수") %>% 
        DT::datatable()
```
<br/>
 먼저, unite를 이용하여 구와 동을 하나의 변수로 합쳐주었습니다.<br/>이후 select로 구_동과 사업체수의 변수만을 뽑아냈습니다.<br/> 그 후 pivot_longer을 이용하여 사업체 유형별 사업체 수를 나타냈습니다.
<br/><br/><br/><br/>
 **10. pivot_wider**
```{r}
# 년도 별 사업체 수 비교
enterprise_2019 <- select(enterprise_2019, 기간, 자치구, 동, 전체_사업체수)

enterprise_2018 <- select(enterprise, 기간, 자치구, 동, 전체_사업체수)

enterprise_2018_2019 <- rbind(enterprise_2018, enterprise_2019)
pivot_wider(enterprise_2018_2019, 
            names_from = 기간, values_from = 전체_사업체수) %>% 
        DT::datatable()
```
<br/>
 pivot_wider의 적용을 위해 enterprise 데이터의 2019년 버전을 새롭게 불러들였습니다.<br/> 이후 각각의 데이터에서 전체 사업체 수 만을 추출한 후, rbind를 통해 하나의 데이터로 합쳐주었습니다.<br/> 그 후, pivot_wider를 이용하여 각 행정동별 2018년과 2019년의 사업체 수를 비교했습니다.
<br/><br/><br/>
```{r}
#시각화
data_10 <- pivot_wider(enterprise_2018_2019, 
            names_from = 기간, values_from = 전체_사업체수)
names(data_10) <- c("자치구", "동", "year_2018", "year_2019")
ggplot(data = data_10) +
        geom_point(mapping = aes(x = year_2018, y = year_2019))+
        ggtitle("2018년과 2019년의 동별 사업체수 분포")+
theme(plot.title = element_text(color = "darkblue", size = 16))
```
```{r}
boxplot(data_10$year_2018, data_10$year_2019, horizontal=T, main="연도에 따른 동별 사업체수 분포", names=c("2018년", "2019년"))
```
<br/><br/><br/><br/>
 **11. spread**
```{r}
# 성별을 계, 남자, 여자로 분리하기
select(registered, 기간, 자치구, 행정동, 성별, 계) %>% 
        arrange(자치구, 행정동) %>% 
        DT::datatable()

select(registered, 기간, 자치구, 행정동, 성별, 계) %>% 
        spread(key = 성별, value = 계) %>% 
        DT::datatable()
```
<br/>
 spread를 사용하기 위해 서울시 행정동 별 등록외국인 수(registered)라는 새로운 데이터를 불러들였습니다.<br/>이후 '성별'이라는 한 변수에 있는 세 항목을 계, 남자, 여자라는 이름의 각각 새로운 변수로 바꾸어 데이터를 보다 넓게 변형하였습니다.
<br/><br/><br/>
```{r}
# 시각화
data_11 <- select(registered, 기간, 자치구, 행정동, 성별, 계) %>% 
        spread(key = 성별, value = 계)

ggplot(data = data_11) +
        geom_point(mapping = aes(x = 남자, y = 여자), color = "red") +
        ggtitle("서울시 행정동별 등록외국인의 성별 분포") +
        theme(plot.title = element_text(color = "darkblue", size = 16))
```
<br/><br/><br/><br/>
 **12. gather**
```{r}
# 공영, 민영 변수를 운영 방식 변수로 바꾸기
parkinglot <- select(parkinglot, 기간, 자치구, 동, 공영_개소, 민영_개소)
names(parkinglot) <- c("기간", "자치구", "동", "공영", "민영")

parkinglot %>% 
        arrange(자치구, 동) %>% 
        DT::datatable()

gather(parkinglot, 공영, 민영, key = "운영 방식", value = "주차장 수") %>% 
        arrange(자치구, 동) %>% 
        DT::datatable()

```
<br/>
 gather를 적용하기 위해 서울시 행정동 별 주차장(parkinglot) 데이터를 불러들였습니다.<br/> 이 데이터는 2018년 서울시에 있는 주차장의 개소와 면수를 공영과 민영에 따라 따로 분류한 데이터입니다.<br/>이를 gather를 사용하여 운영 방식이라는 새로운 변수로 대체하여 데이터를 보다 길게 변형하였습니다.
<br/><br/><br/>
```{r}
#시각화
ggplot(data = parkinglot) +
        geom_point(mapping = aes(x = 공영, y = 민영), color = "blue") + 
        theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
        ggtitle("서울시 행정동별 민영과 공영 주차장 분포") +
        theme(plot.title = element_text(color = "darkblue", size = 16))
```