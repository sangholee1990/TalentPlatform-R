---
title: "Assignment 5: Under (blood) pressure"
author: Sangwon Yum
date: "`r Sys.Date()`"
documentclass: article
geometry: margin=1in
fontsize: 11pt
output:
  pdf_document:
    toc: false
    df_print: kable
    fig_caption: false
    number_sections: false
    dev: pdf
    highlight: tango
    latex_engine: xelatex
  html_document:
    theme: default
    self_contained: true
    toc: false
    df_print: kable
    fig_caption: false
    number_sections: false
    smart: true
    dev: svg
    latex_engine: xelatex
---

```{r setup, include = FALSE}
# DO NOT ALTER THIS CHUNK
knitr::opts_chunk$set(
  echo = TRUE,
  eval = TRUE,
  fig.width = 5,
  fig.asp = 0.618,
  out.width = "70%",
  dpi = 120,
  fig.align = "center",
  cache = FALSE
)

# Load required packages
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(broom))
suppressPackageStartupMessages(library(modelr))
# Load dataset
blood_pressure <- read_rds("blood_pressure.rds")
```

## Exercise 1

```{r, fig.asp= 1, fig.width = 8, out.width = "100%"}
blood_pressure %>%
  pivot_longer(cols = Age:Pulse, names_to = "measurement", values_to = "value") %>%
  ggplot() +
    geom_point(mapping = aes(x = value, y = Systol)) +
    facet_wrap(~ measurement, scales = "free_x") +
    geom_smooth(mapping = aes(x = value, y = Systol), method = "lm") +
    labs(x = "Measurement Value", y = "Systolic Blood Pressure", title = "Scatter Plot of Various Measurements vs Systolic Blood Pressure")
```

## Exercise 2
- Q) What type of correlation does the "Years" variable demonstrate with "Systol"?
  - Positive?
  - Negative?
  - None?
- A) 0값에 매우 가깝기 때문에 None (-0.087)

- Q) Which variable shows a moderate-to-strong positive correlation with "Systol"?
- A) Weight (0.521)
```{r, fig.asp= 1, fig.width = 8, out.width = "100%"}
blood_pressure %>%
  pivot_longer(cols = Age:Pulse, names_to = "measurement", values_to = "value") %>%
  ggplot() +
    geom_point(mapping = aes(x = value, y = Systol)) +
    facet_wrap(~ measurement, scales = "free_x") +
    geom_smooth(mapping = aes(x = value, y = Systol), method = "lm")

# 상관계수
cor(blood_pressure)[ ,1] %>% sort()
```

i. What type of correlation does the "Years" variable demonstrate with "Systol"?
+ Negative

ii. Which variable shows a moderate-to-strong positive correlatio with "Systol"?
+

## Exercise 3

```{r}
blood_pressure_updated = blood_pressure %>%
  mutate(
    urban_frac_life = Years / Age
    )
```

## Exercise 4

```{r}
systol_urban_frac_model = lm(Systol ~ urban_frac_life, data  = blood_pressure_updated)
```



## Exercise 5
```{r}
systol_urban_frac_model %>% 
  tidy()

model_performance = glance(systol_urban_frac_model)
print(model_performance[, 1:3])
```

## Exercise 6
- Q) What is the name of the column that holds the response variable values predicted by the model?
- A) pred

- Q) What is the name of the column that holds the residuals for each observation?
- A) resid
```{r}
systol_urban_frac_df = blood_pressure_updated %>% 
  add_predictions(systol_urban_frac_model) %>% 
  add_residuals(systol_urban_frac_model)

print(systol_urban_frac_df)
```

## Exercise 7
- Q) Does your model meet the linearity condition?
- A) 적색선을 기준으로 대칭적으로 고르게 분포되어 있어서 선형성을 만족함
```{r}
ggplot() +
  geom_point(mapping = aes(x = pred, y = Systol), data = systol_urban_frac_df) +
  geom_abline(slope = 1, intercept = 0, color = "red") +
   labs(title="Actual vs Predicted", x="Urban frac life", y="Actual")

# 선형성 검정 결과 P값은 0.08881로서 0.05 이하 유의수준보다 낮기 때문에 귀무가설을 채택하여 상관계수 0이 아님 (선형성 있음) 
cor.test(systol_urban_frac_df$pred, systol_urban_frac_df$Systol)
```

## Exercise 8
- Q) Does it look like the variability is reasonably constant all the way along the line?
- A) 적색 선을 기준으로 고르게 분포되어 있기 때문에 잔차의 변동성은 일정함

- Q) Does the model meet the third criteria of constant variability of residuals?
- A) 앞선 답변과 동일
```{r}
ggplot(systol_urban_frac_df, aes(x=pred, y=resid)) + 
  geom_point() + 
  geom_hline(yintercept = 0, color = "red") + 
  labs(title="Residuals vs Predicted", x="Predicted", y="Residuals")
```

## Exercise 9
What is the shape of the distribution of the residuals?
- Q) Symmetric?
- A) No, 비대칭

- Q) Skewed?
- A) 우측으로 기울어짐

- Q) Does the model seem to meet the second condition of nearly normal residuals? Why or why not?
- A) 아니요, 모델은 거의 정상적인 잔차의 조건을 충족하지 않는 것으로 보입니다. 잔차 히스토그램이 정규분포를 띠지 않고, 특히 한쪽으로 기울어진 비대칭 형태를 보이
```{r}
ggplot(systol_urban_frac_df, aes(x=resid)) +
  geom_histogram(binwidth=0.5) +
  labs(title="Histogram of Residuals", x="Residuals", y="Frequency")
```

## Exercise 10
- Q) Does this new model perform better or worse than the previous model?
- A) 신규 선형 모델 (systol_weight_model)의 결정계수는 0.27로서 기존 선형 모델 (systol_urban_frac_model, 결정계수 = 0.07)보다 좋은 예측 성능을 보임
```{r}
systol_weight_model = lm(Systol ~ Weight, data = blood_pressure_updated)

systol_weight_model %>% 
  tidy()

systol_weight_model %>% 
  glance() %>% 
  dplyr::select(1:5)
```

## Exercise 11
- Q) Does this model and the visualizations created from it follow the assumptions necessary for a linear model?
- A) 적색선을 기준으로 대칭적으로 고르게 분포되어 있어서 선형성을 만족함

- Q) Does the model meet the third criteria of constant variability of residuals?
- A) 앞선 답변과 동일

Should we conclude that the second model is reliable? Why or why not?
- Q) Symmetric?
- A) 대칭

- Q) Skewed?
- A) No

- Q) Does the model seem to meet the second condition of nearly normal residuals? Why or why not?
- A) 잔차 히스토그램에서 0을 기준으로 정규 분포를 띠기 때문에 정상적인 잔차로 판단됨
```{r}
# Exercise 06
systol_weight_df = blood_pressure_updated %>% 
  add_predictions(systol_weight_model) %>% 
  add_residuals(systol_weight_model)
print(systol_weight_df)

# Exercise 07
ggplot(systol_weight_df) +
  geom_point(mapping = aes(x = pred, y = Systol)) +
  geom_abline(intercept=0, slope=1, color="red") +
  labs(title="Actual vs Predicted", x="Predicted", y="Actual")

# Exercise 09
ggplot(systol_weight_df, aes(x=resid)) +
  geom_histogram(binwidth=0.5) +
  labs(title="Histogram of Residuals", x="Residuals", y="Frequency")
```

## Exercise 12
How does the second model compare with the first in terms of
- Q) Their R2 values
- A) 신규 선형 모델 (systol_weight_model)의 수정된 결정계수는 0.27로서 기존 선형 모델 (model_performance, 결정계수 = 0.07)보다 좋은 예측 성능을 보임

- Q) How well they meet the 3 assumptions
- A) 신규/기존 선형 모델은 선형성, 정상적인 잔차, 로 판단됨
```{r}
summary(systol_urban_frac_model)
summary(systol_weight_model)
```